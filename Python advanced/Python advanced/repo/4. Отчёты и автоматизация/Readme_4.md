Часть 4: отчеты и автоматизация

#Работа с PDF

Задание
Используя данные по посещаемости библиотек в районах Москвы
https://video.ittensive.com/python-advanced/data-7361-2019-11-28.utf.json
постройте круговую диаграмму суммарной посещаемости (NumOfVisitors) 20 наиболее популярных районов Москвы.
Создайте PDF отчет, используя файл
https://video.ittensive.com/python-advanced/title.pdf
как первую страницу. На второй странице выведите итоговую диаграмму, самый популярный район Москвы и число посетителей библиотек в нем.

Решение:
1)	подключаем все нужные нам библиотеки
2)	создаём функцию, для извлечения название района, из поля District, функция берёт значение серии ObjectAddress, находит в этом значении поля District, приводит это поля к списку, и возвращает первое значение из этого списка, по факту будет вычленять первый найденный District из словаря ObjectAddress, получаем нужные данные, с помощью запроса с методом get
3)	полученные данные передаём во фрейм, результат разбора json-файла, также заполняем нулями отсутствующие значения
4)	для группировки по районам, нам нужно извлечь название района из поля District, которое является, json разобранным в словарь
5)	после получения района для всех значений данных, можно сгруппировать по нему, и отсортировать по часу посетителей библиотек, в порядке убывания
6)	создаём холст   
7)	наносим на него подобласть
8)	строим результирующую диаграмму из 20 самых популярных районов, для большей читаемости уберём районы из подписи на диаграмме, задав пустые labels ровно по числу наших районов
9)	переносим все наши районы в легенду, это будет индекс из нашего набора данных, легенду выведем справа от диаграммы, сохраняем график в файл, для дальнейшей вставки в наш отчёт
10)	начинаем формирования отчёта, задаём шрифты
11)	задаём холст с размерами, наносим на холст данные
12)	 создаём вторую страницу отчёта
13)	вставляем диаграмму, в виде отдельного изображения
14)	из того файла, что мы сохранили ранее
15)	дополнительно выедем информацию по самому популярному району
16)	это первый район в отсортированном списке
17)	выводим первое число посетителей в нашем кортеже
18)	объединяем сгенерированный отчёт, и титульную страницу через PdfFileMerger()
19)	создаём PDF файл report.pdf

#Базовые отчеты

Задание

Сгенерируйте PDF документ из списка флагов и гербов районов Москвы:
https://video.ittensive.com/python-advanced/data-102743-2019-11-13.utf.csv
На каждой странице документа выведите название геральдического символа (Name), его описание (Description) и его изображение (Picture).
Для показа изображений используйте адрес
https://op.mos.ru/MEDIA/showFile?id=XXX
где XXX - это значение поля Picture в наборе данных. Например:
https://op.mos.ru/MEDIA/showFile?id=8466da35-6801-41a9-a71e-04b60408accb
Решение:
1)	подключаем нужные библиотеки
2)	загружаем файл с данными
3)	формируем html документ, в заголовке указываем "Геральдические символы Москвы", кодировка utf-8, после этого нам нужно добавить в документ, постраничный вывод данных
4)	выведем заголовки одного уровня, и зададим стили для всех кроме первого
5)	перебираем в цикле наш набор данных data.iterrows()
6)	только для первого элемента мы не будем задавать стиль
7)	для всех остальных задаём стили, и ставим разрыв страницы, после первого заголовка, таким образом мы получим каждый геральдический символ с названием, на отдельной страницы
8)	после заголовка, который будет обеспечивать разрыв страницы, мы выведем изображения геральдического изображения, в увеличенном виде, используем для этого атрибут style и свойство width (ширина), сделаем отступ слева margin-left:10%, источник изображения зададим через ссылку, в нужном формате, возьмём исходный формат ссылки, и добавим к нему значение поля Picture из нашего кортежа данных
9)	выводим описание символа, увеличиваем шрифт для читаемости с помощью font-size, выведем свойство Description у нашего кортежа
10)	конфигурируем pdfkit стандартным образом, указав путь до бинарного файла
11)	зададим стандартные настройки: размер страницы, пагинацию (вывод страницы на каждой страницы)
12)	сохраняем результат, в виде файла heraldic.pdf

#Генерация отчетов

Задание

Используя данные по активностям в парках Москвы
https://video.ittensive.com/python-advanced/data-107235-2019-12-02.utf.json
Создайте PDF отчет, в котором выведите:
1. Диаграмму распределения числа активностей по паркам, топ10 самых активных
2. Таблицу активностей по всем паркам в виде Активность-Расписание-Парк
Решение:
1)	подключаем нужные нам библиотеки
2)	получаем нужные данные
3)	формируем набор данных только из колонок "CourseName", "CoursesTimetable", "NameOfPark"именно эти колонки нужны нам для вывода в отчёте
4)	получаем название парка из комбинированной серии, получаем значение value словаря
5)	переименовываем колонки для отчёта
6)	для ответа на поставленный вопрос найдём активность Тайцзицюань, и выведем число записей с этой активностью
7)	формируем диаграмму активности по паркам
8)	создаём холст
9)	проводим группировку данных по парку, отсортируем эту группировку в порядке убывания, чтобы взять первые 20 значений по посещаемости, и нанести их на круговую диаграмму
10)	для временного хранения бинарных файлов изображения используем BytesIO() и его дальнейшего преобразование в base64 – формат
11)	по факту у нас будет некоторый указатель в памяти, который мы используем, для хранения данных изображения, преобразовываем бинарные данные к base64, данные декодируем в UTF – 8
12)	преобразовываем бинарные данные к base64, данные декодируем в UTF – 8
13)	указываем максимальное количество символов в ячейках
14)	Формируем html - отчёт, в отчёте выводим изображение, уровень активности парка и расписание
15)	генерируем PDF - файл, из html - строки, используя pdfkit
16)	сохраняем полученный результат в файл parks.pdf

#Отправка email и интеграция

Задание
Соберите отчет по результатам ЕГЭ в 2018-2019 году, используя данные
https://video.ittensive.com/python-advanced/data-9722-2019-10-14.utf.csv
и отправьте его в HTML формате по адресу support@ittensive.com, используя только Python.
В отчете должно быть:
•	общее число отличников (учеников, получивших более 220 баллов по ЕГЭ в Москве),
•	распределение отличников по округам Москвы,
•	название школы с лучшими результатами по ЕГЭ в Москве.
Диаграмма распределения должна быть вставлена в HTML через data:URI формат (в base64-кодировке).
Дополнительно: приложите к отчету PDF документ того же содержания (дублирующий письмо).
Решение:
1)	подключаем нужные нам библиотеки
2)	получаем необходимые данные
3)	выделяем из данных результаты только 2018-2019 годов
4)	ищем лучшею школу по результатам ЕГЭ, выполняем сортировку по PASSES_OVER_220, и берём первое значение, сортировка значений также позволяет вынести два самых малочисленных значения, чтобы подписи поместились на графике
5)	выполняем группировку по административному округу, предварительно уберём из этой серии данных все слова, кроме первого, для того чтобы подписи данных были короче
6)	считаем общее число отличников, оно нужно для отчёта и для вывода доли
7)	создаём холст
8)	на холст задаём список explode, список секторов
9)	указываем меру их выноса из основной диаграммы
10)	создаём круговую диаграмму по округа
11)	в подписи передадим пустой набор данных по числу округов
12)	выведем названия
13)	создаём авто подписи данных, которые сформируем, из доли точного значения отличников по округам
14)	список для выноса секторов
15)	справа выведем легенд с подписями округов  
16)	сохраняем диаграмму, как изображения для выставки изображения в отчёт
17)	для выставки изображения в отчёт, преобразуем его в base64 – кодировку стандартным образом
18)	задаём настройку pandas по длине значения в колонке
19)	формируем html - отчёт со всеми данными, задаём кодировку, заголовок, вставим суммарное значение числа отличников, распределение по округам, нашу диаграмму, и название лучшей школы
20)	из html - документа формируем pdf - отчёт, через pdfkit, конфигурируем бинарный файл, задаём настройки, размер страницы и вывод номера страницы, на каждой страницы
21)	вызываем генерацию pdf документа, сохраняем его как ege.best.pdf в качестве параметров передаём config и options
22)	приступаем к отправке письма, создаём новый объект MIMEMultipart()
23)	задаём ему поля, отправитель, тему, тип, и адрес отправки
24)	к телу письма прикрепим наш html – документ
25)	в качестве вложения добавляем наш pdf – отчёт
26)	подключаемся к почтовому серверу и отправляем письмо на адрес support@ittensive.com также указываем логин и пароль
27)	закрываем соединение с сервером
